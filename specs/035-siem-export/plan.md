# Implementation Plan: SIEM Export & Audit Streaming

**Branch**: `035-siem-export` | **Date**: 2026-02-13 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/035-siem-export/spec.md`

## Summary

Admin UI for managing SIEM export destinations and batch audit exports. Admins can configure streaming destinations (Syslog TCP/TLS, Syslog UDP, Webhook, Splunk HEC) with per-destination circuit breaker settings, monitor delivery health with latency and success rate metrics, inspect and redeliver dead-letter events, and generate one-off batch exports of audit events in CEF, Syslog RFC 5424, JSON, or CSV format. The backend (xavyo-idp) exposes 14 REST endpoints at `/governance/siem/`. The frontend implements a SIEM hub with 2 tabs (Destinations, Batch Exports), destination detail with 3 tabs (Details, Health, Dead Letter), and follows the established BFF proxy pattern with Superforms for CRUD.

## Technical Context

**Language/Version**: TypeScript 5.x / Svelte 5 (runes mode) + SvelteKit
**Primary Dependencies**: Bits UI, Tailwind CSS v4, Superforms + Zod (via `zod/v3`), lucide-svelte
**Storage**: N/A (all data via xavyo-idp REST API through BFF proxy)
**Testing**: Vitest + @testing-library/svelte (unit), Chrome DevTools MCP (E2E)
**Target Platform**: Web (modern browsers)
**Project Type**: Web application (SvelteKit frontend + Rust/Axum backend)
**Performance Goals**: Health dashboard loads < 2s, dead letter list paginates smoothly at 100+ entries
**Constraints**: Admin role required for all endpoints, pagination `{items, total, limit, offset}`, max batch export range 90 days
**Scale/Scope**: ~30 new files, ~14 BFF proxy routes, ~4 Zod schemas, ~4 UI components, ~80-100 new tests

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. BFF Security | PASS | All API calls go through SvelteKit server via BFF proxies at `src/routes/api/governance/siem/`. Tokens in HttpOnly cookies, never exposed to client. Auth credentials (API keys, HEC tokens) sent only in create/update requests, never returned by backend (`has_auth_config` boolean flag instead). |
| II. Test-Driven Development | PASS | Unit tests for all schemas, API clients, components, and pages. E2E via Chrome DevTools MCP. |
| III. Honest Reviews | PASS | Post-implementation review with `npm run check` + `npm run test:unit` + E2E verification. |
| IV. Svelte 5 Runes Only | PASS | All components use `$state`, `$derived`, `$effect`, `$props`. No legacy patterns. |
| V. Minimal Complexity | PASS | One function per endpoint, flat file structure, no premature abstractions. Tabs reuse existing Bits UI Tabs pattern. Circuit state badge is a simple component. |
| VI. Type Safety | PASS | Types in `src/lib/api/types.ts` mirror Rust DTOs. Zod schemas match types. No `any`. |
| VII. English Only | PASS | All code and UI text in English. |
| VIII. Backend Fidelity | PASS | All 14 endpoints verified in backend. No mocked features. |

**Post-Phase 1 Re-check**: All gates still pass. No new violations introduced by design decisions.

## Project Structure

### Documentation (this feature)

```text
specs/035-siem-export/
├── plan.md              # This file
├── data-model.md        # Entity definitions
├── contracts/
│   └── siem-api.md      # REST API contracts
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/
├── lib/
│   ├── api/
│   │   ├── types.ts                    # Add SIEM types (modify)
│   │   ├── siem.ts                     # Server-side API client
│   │   ├── siem.test.ts                # API client tests
│   │   ├── siem-client.ts              # Client-side API functions
│   │   └── siem-client.test.ts         # Client API tests
│   ├── schemas/
│   │   ├── siem.ts                     # Zod validation schemas
│   │   └── siem.test.ts                # Schema validation tests
│   └── components/
│       └── siem/                       # Feature components
│           ├── circuit-state-badge.svelte
│           ├── circuit-state-badge.test.ts
│           ├── health-summary-cards.svelte
│           ├── health-summary-cards.test.ts
│           ├── destination-type-badge.svelte
│           ├── destination-type-badge.test.ts
│           ├── export-status-badge.svelte
│           └── export-status-badge.test.ts
├── routes/
│   ├── api/governance/siem/
│   │   ├── destinations/
│   │   │   ├── +server.ts                  # GET list, POST create
│   │   │   └── [id]/
│   │   │       ├── +server.ts              # GET, PUT, DELETE
│   │   │       ├── test/+server.ts         # POST test connectivity
│   │   │       ├── health/+server.ts       # GET health summary
│   │   │       ├── health/history/+server.ts # GET health history
│   │   │       ├── dead-letter/+server.ts  # GET dead letter list
│   │   │       └── dead-letter/redeliver/+server.ts  # POST redeliver
│   │   └── exports/
│   │       ├── +server.ts                  # GET list, POST create
│   │       └── [id]/
│   │           ├── +server.ts              # GET export detail
│   │           └── download/+server.ts     # GET download
│   └── (app)/governance/siem/
│       ├── +page.server.ts             # Hub page server load
│       ├── +page.svelte                # Hub with 2 tabs (Destinations, Batch Exports)
│       ├── siem.test.ts                # Hub page tests
│       ├── create/
│       │   ├── +page.server.ts         # Create destination form + action
│       │   ├── +page.svelte            # Create destination form UI
│       │   └── create.test.ts
│       ├── [id]/
│       │   ├── +page.server.ts         # Detail load + actions (test, delete)
│       │   ├── +page.svelte            # Detail with 3 tabs (Details, Health, Dead Letter)
│       │   └── detail.test.ts
│       ├── [id]/edit/
│       │   ├── +page.server.ts         # Edit form + action
│       │   ├── +page.svelte            # Edit form UI
│       │   └── edit.test.ts
│       └── exports/
│           └── create/
│               ├── +page.server.ts     # Create export form + action
│               ├── +page.svelte        # Create export form UI
│               └── export-create.test.ts
```

**Structure Decision**: Follows existing xavyo-web patterns -- feature routes under `(app)/governance/siem/`, BFF proxies under `api/governance/siem/`, API clients in `lib/api/`, schemas in `lib/schemas/`. Hub page with tabs pattern matches governance, federation, and license management hubs.

## User Stories

### US-1: Destination CRUD
**As an** admin, **I want to** create, view, edit, and delete SIEM export destinations **so that** I can configure where audit events are streamed.

**Acceptance Criteria**:
- Hub page lists all destinations with name, type, format, circuit state, and enabled status
- Create form validates endpoint_host, endpoint_port (required for syslog types), and shows conditional fields per destination_type (Splunk HEC fields, syslog facility, TLS options)
- Detail page shows all destination config in a read-only summary with 3 tabs
- Edit form pre-fills all fields, validates same as create
- Delete action requires confirmation dialog
- Enable/disable toggle on detail page

**Files**: Hub page, create page, detail page, edit page, BFF destinations proxy, API client, schemas

### US-2: Test Connectivity
**As an** admin, **I want to** test a destination's connectivity **so that** I can verify it is reachable before enabling event streaming.

**Acceptance Criteria**:
- "Test Connection" button on destination detail page
- Shows spinner during test
- On success: displays success message with latency_ms
- On failure: displays error message from backend
- Does not change destination state

**Files**: Detail page, BFF test proxy, API client

### US-3: Health Monitoring
**As an** admin, **I want to** view delivery health metrics for each destination **so that** I can monitor streaming reliability.

**Acceptance Criteria**:
- Health tab on destination detail shows summary cards: total sent, delivered, failed, dropped, avg latency, success rate %, dead letter count
- Circuit state badge shows closed (green), open (red), half_open (yellow)
- Health history table shows time-windowed entries with p95 latency
- Auto-refresh health summary every 30 seconds via client-side polling

**Files**: Detail page (Health tab), health-summary-cards component, circuit-state-badge component, BFF health proxies, API client

### US-4: Dead Letter Queue
**As an** admin, **I want to** inspect failed event deliveries and redeliver them **so that** no audit events are permanently lost.

**Acceptance Criteria**:
- Dead Letter tab on destination detail lists failed/dead_letter events with event type, timestamp, retry count, error detail
- Redeliver button triggers redelivery of all dead letter events for this destination
- Shows count of events requeued on success
- Paginated list with standard `{items, total, limit, offset}` format

**Files**: Detail page (Dead Letter tab), BFF dead-letter proxies, API client

### US-5: Batch Export
**As an** admin, **I want to** create and download batch exports of audit events **so that** I can perform offline analysis or feed external compliance tools.

**Acceptance Criteria**:
- Batch Exports tab on hub page lists all exports with date range, format, status, file size
- Create export form: date range picker (start/end), event type filter (multi-select from 9 categories), output format selector
- Export status shows pending/processing/completed/failed with appropriate badge colors
- Download link available when status is completed and before expires_at
- File size displayed in human-readable format (KB, MB)

**Files**: Hub page (Batch Exports tab), export create page, BFF export proxies, export-status-badge component, API client

### US-6: Sidebar Navigation
**As an** admin, **I want to** access SIEM management from the sidebar **so that** I can navigate to it consistently with other governance features.

**Acceptance Criteria**:
- "SIEM" nav item under Governance section in sidebar
- Only visible to admin users (admin or super_admin role)
- Links to `/governance/siem`
- Active state highlights when on any `/governance/siem/*` route

**Files**: Sidebar component (modify existing)

## Key Design Decisions

### D-1: Auth Config Security
Auth credentials (API keys, Bearer tokens, Splunk HEC tokens) are write-only. The backend accepts them on create/update but never returns them in responses. Instead, `has_auth_config` boolean indicates whether credentials are configured. The edit form shows a "credentials configured" indicator and allows overwriting but never displays existing values.

### D-2: Circuit Breaker Display
Circuit state is a read-only backend-managed field. The frontend displays it via a badge component but never allows direct manipulation. The circuit breaker threshold and cooldown are configuration fields editable by the admin.

### D-3: Conditional Form Fields
The create/edit forms use `$derived` to show/hide fields based on `destination_type`:
- **syslog_tcp_tls**: Shows endpoint_port (required), syslog_facility, tls_verify_cert
- **syslog_udp**: Shows endpoint_port (required), syslog_facility
- **webhook**: Hides port, shows auth config fields
- **splunk_hec**: Shows splunk_source, splunk_sourcetype, splunk_index, splunk_ack_enabled, auth config

### D-4: Health Polling
Health summary uses client-side `setInterval` at 30-second intervals via `$effect` with cleanup. Polling pauses when the Health tab is not active (tracked via tab value state).

### D-5: Download Handling
Batch export download uses a direct link to the BFF proxy which streams the response from the backend. The BFF sets `Content-Disposition: attachment` header. No client-side file construction needed.

## Complexity Tracking

No constitution violations to justify. All principles pass cleanly.

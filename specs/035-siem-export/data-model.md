# Data Model: SIEM Export & Audit Streaming

**Feature**: 035-siem-export
**Date**: 2026-02-13

## Entity Relationship Overview

```
SiemDestination 1──* SiemExportEvent (dead letter entries)
SiemDestination 1──* SiemDeliveryHealth (time-windowed history)
SiemDestination 1──1 SiemHealthSummary (computed aggregate)
SiemBatchExport (standalone, requested by admin)
```

## Entities

### SiemDestination

The core entity representing a streaming export target for audit events.

| Field | Type | Required | Constraints | Notes |
|-------|------|----------|-------------|-------|
| id | string (UUID) | auto | PK | Generated by backend |
| tenant_id | string (UUID) | auto | FK | Tenant scope |
| name | string | yes | 1-255 chars, unique per tenant | Human-readable destination name |
| destination_type | DestinationType | yes | enum | `syslog_tcp_tls` \| `syslog_udp` \| `webhook` \| `splunk_hec` |
| endpoint_host | string | yes | valid hostname/IP | Target host address |
| endpoint_port | number \| null | conditional | 1-65535 | Required for syslog types, optional for webhook/splunk |
| export_format | ExportFormat | yes | enum | `cef` \| `syslog_rfc5424` \| `json` \| `csv` |
| has_auth_config | boolean | computed | read-only | Whether auth credentials are configured (write-only) |
| event_type_filter | string[] | yes | JSON array of EventCategory | Which event categories to stream |
| rate_limit_per_second | number | yes | >= 1 | Max events per second |
| queue_buffer_size | number | yes | >= 100 | Internal queue capacity |
| circuit_breaker_threshold | number | yes | >= 1 | Consecutive failures before circuit opens |
| circuit_breaker_cooldown_secs | number | yes | >= 1 | Seconds before half_open retry |
| circuit_state | CircuitState | computed | read-only | `closed` \| `open` \| `half_open` |
| circuit_last_failure_at | string (ISO 8601) \| null | computed | read-only | Last circuit breaker trip timestamp |
| enabled | boolean | yes | -- | Whether streaming is active |
| splunk_source | string \| null | conditional | -- | Splunk HEC source (splunk_hec only) |
| splunk_sourcetype | string \| null | conditional | -- | Splunk HEC sourcetype (splunk_hec only) |
| splunk_index | string \| null | conditional | -- | Splunk HEC target index (splunk_hec only) |
| splunk_ack_enabled | boolean | yes | default false | Splunk indexer acknowledgment (splunk_hec only) |
| syslog_facility | number | yes | 0-23 | Syslog facility code (syslog types only), default 1 (user) |
| tls_verify_cert | boolean | yes | default true | Verify TLS certificate (syslog_tcp_tls only) |
| created_at | string (ISO 8601) | auto | -- | Creation timestamp |
| updated_at | string (ISO 8601) | auto | -- | Last update timestamp |
| created_by | string (UUID) | auto | -- | Creator's user ID |

**Auth Config (write-only)**: On create/update, the request may include an `auth_config` object that is stored encrypted on the backend but never returned. The `has_auth_config` boolean indicates whether credentials exist.

```typescript
// Auth config shape (sent on create/update only, never returned)
auth_config?: {
  auth_type: 'none' | 'bearer_token' | 'api_key' | 'basic';
  token?: string;       // For bearer_token
  api_key?: string;     // For api_key
  username?: string;    // For basic
  password?: string;    // For basic
  header_name?: string; // Custom header name for api_key, default 'X-API-Key'
}
```

### SiemBatchExport

A one-off export of audit events for a date range, downloadable as a file.

| Field | Type | Required | Constraints | Notes |
|-------|------|----------|-------------|-------|
| id | string (UUID) | auto | PK | Generated by backend |
| tenant_id | string (UUID) | auto | FK | Tenant scope |
| requested_by | string (UUID) | auto | -- | Admin who requested |
| date_range_start | string (ISO 8601) | yes | -- | Start of export window |
| date_range_end | string (ISO 8601) | yes | must be > date_range_start, max 90 days range | End of export window |
| event_type_filter | string[] | yes | JSON array of EventCategory | Which event categories to include |
| output_format | ExportFormat | yes | enum | `cef` \| `syslog_rfc5424` \| `json` \| `csv` |
| status | BatchExportStatus | computed | enum | `pending` \| `processing` \| `completed` \| `failed` |
| total_events | number \| null | computed | -- | Total events in export (set on completion) |
| file_size_bytes | number \| null | computed | -- | Export file size (set on completion) |
| error_detail | string \| null | computed | -- | Error message if status is failed |
| started_at | string (ISO 8601) \| null | computed | -- | When processing began |
| completed_at | string (ISO 8601) \| null | computed | -- | When processing finished |
| expires_at | string (ISO 8601) \| null | computed | -- | Download link expiry (set on completion) |
| created_at | string (ISO 8601) | auto | -- | Request timestamp |

**State Transitions**:
```
pending → processing   (backend picks up the job)
processing → completed (all events exported successfully)
processing → failed    (error during export)
```

### SiemHealthSummary

Computed aggregate health metrics for a destination. Not persisted as a separate entity -- the backend computes it from delivery history.

| Field | Type | Required | Constraints | Notes |
|-------|------|----------|-------------|-------|
| destination_id | string (UUID) | yes | FK | Parent destination |
| total_events_sent | number | yes | >= 0 | Total events attempted |
| total_events_delivered | number | yes | >= 0 | Successfully delivered |
| total_events_failed | number | yes | >= 0 | Failed after all retries |
| total_events_dropped | number | yes | >= 0 | Dropped (rate limited or queue full) |
| avg_latency_ms | number \| null | yes | -- | Average delivery latency, null if no deliveries |
| last_success_at | string (ISO 8601) \| null | yes | -- | Most recent successful delivery |
| last_failure_at | string (ISO 8601) \| null | yes | -- | Most recent failed delivery |
| success_rate_percent | number | yes | 0.0-100.0 | (delivered / sent) * 100 |
| circuit_state | CircuitState | yes | enum | Current circuit breaker state |
| dead_letter_count | number | yes | >= 0 | Events in dead letter queue |

### SiemDeliveryHealth

Time-windowed health metrics for a destination. Each row represents one observation window (e.g., 1-hour or 15-minute buckets).

| Field | Type | Required | Constraints | Notes |
|-------|------|----------|-------------|-------|
| id | string (UUID) | auto | PK | Generated by backend |
| destination_id | string (UUID) | yes | FK | Parent destination |
| window_start | string (ISO 8601) | yes | -- | Window start timestamp |
| window_end | string (ISO 8601) | yes | must be > window_start | Window end timestamp |
| events_sent | number | yes | >= 0 | Events attempted in window |
| events_delivered | number | yes | >= 0 | Successfully delivered in window |
| events_failed | number | yes | >= 0 | Failed in window |
| events_dropped | number | yes | >= 0 | Dropped in window |
| avg_latency_ms | number \| null | yes | -- | Average latency in window |
| p95_latency_ms | number \| null | yes | -- | 95th percentile latency in window |
| last_success_at | string (ISO 8601) \| null | yes | -- | Last success in window |
| last_failure_at | string (ISO 8601) \| null | yes | -- | Last failure in window |
| created_at | string (ISO 8601) | auto | -- | Row creation timestamp |

### SiemExportEvent

Individual audit event delivery record. Used for dead letter queue inspection.

| Field | Type | Required | Constraints | Notes |
|-------|------|----------|-------------|-------|
| id | string (UUID) | auto | PK | Generated by backend |
| destination_id | string (UUID) | yes | FK | Target destination |
| source_event_id | string (UUID) | yes | FK | Original audit event ID |
| source_event_type | string | yes | EventCategory value | Event category |
| event_timestamp | string (ISO 8601) | yes | -- | Original event timestamp |
| formatted_payload | string \| null | yes | -- | Formatted event body (CEF/syslog/JSON/CSV) |
| delivery_status | DeliveryStatus | yes | enum | `pending` \| `delivered` \| `failed` \| `dead_letter` \| `dropped` |
| retry_count | number | yes | >= 0 | Number of delivery attempts |
| next_retry_at | string (ISO 8601) \| null | yes | -- | Scheduled next retry (if pending) |
| last_attempt_at | string (ISO 8601) \| null | yes | -- | Last delivery attempt timestamp |
| error_detail | string \| null | yes | -- | Last error message |
| delivered_at | string (ISO 8601) \| null | yes | -- | Successful delivery timestamp |
| delivery_latency_ms | number \| null | yes | -- | Delivery latency in milliseconds |
| created_at | string (ISO 8601) | auto | -- | Record creation timestamp |

### TestConnectivityResponse

Response from the test connectivity endpoint. Not a persisted entity.

| Field | Type | Required | Constraints | Notes |
|-------|------|----------|-------------|-------|
| success | boolean | yes | -- | Whether connection succeeded |
| latency_ms | number \| null | yes | -- | Round-trip latency (null on failure) |
| error | string \| null | yes | -- | Error message (null on success) |

### RedeliverResponse

Response from the dead letter redeliver endpoint. Not a persisted entity.

| Field | Type | Required | Constraints | Notes |
|-------|------|----------|-------------|-------|
| events_requeued | number | yes | >= 0 | Number of dead letter events requeued for retry |

## Enums

### DestinationType

| Value | Description |
|-------|-------------|
| `syslog_tcp_tls` | Syslog over TCP with TLS encryption |
| `syslog_udp` | Syslog over UDP (plaintext) |
| `webhook` | HTTP/HTTPS webhook endpoint |
| `splunk_hec` | Splunk HTTP Event Collector |

### ExportFormat

| Value | Description |
|-------|-------------|
| `cef` | Common Event Format (ArcSight compatible) |
| `syslog_rfc5424` | Syslog RFC 5424 structured data |
| `json` | JSON (newline-delimited for streaming, array for batch) |
| `csv` | Comma-separated values |

### CircuitState

| Value | Description | Badge Color |
|-------|-------------|-------------|
| `closed` | Normal operation, events flowing | Green |
| `open` | Circuit tripped, events queued/dropped | Red |
| `half_open` | Testing recovery, limited throughput | Yellow |

### BatchExportStatus

| Value | Description | Badge Color |
|-------|-------------|-------------|
| `pending` | Export queued, not yet started | Gray |
| `processing` | Export in progress | Blue |
| `completed` | Export finished, download available | Green |
| `failed` | Export failed, see error_detail | Red |

### DeliveryStatus

| Value | Description |
|-------|-------------|
| `pending` | Queued for delivery |
| `delivered` | Successfully delivered |
| `failed` | Failed but may retry |
| `dead_letter` | Exhausted retries, in dead letter queue |
| `dropped` | Dropped (rate limit or queue overflow) |

### EventCategory

The 9 event categories that can be filtered for streaming or batch export.

| Value | Description |
|-------|-------------|
| `authentication` | Login, logout, MFA, password change events |
| `user_lifecycle` | User create, update, disable, delete events |
| `group_changes` | Group membership add/remove events |
| `access_requests` | Access request create, approve, reject events |
| `provisioning` | Provisioning run, assignment, deprovisioning events |
| `administrative` | Tenant settings, branding, OAuth client changes |
| `security` | Security alerts, suspicious activity, device trust |
| `entitlement` | Entitlement create, update, assignment events |
| `sod_violation` | Separation of duty violation detections |

## Pagination

All list endpoints use `{items, total, limit, offset}` format (standard governance pagination).
Default: limit=20 (max 100), offset=0.

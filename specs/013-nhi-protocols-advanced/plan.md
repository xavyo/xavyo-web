# Implementation Plan: NHI Protocols & Advanced

**Branch**: `013-nhi-protocols-advanced` | **Date**: 2026-02-11 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/013-nhi-protocols-advanced/spec.md`

## Summary

Extend the existing NHI module with four new capabilities: MCP tool discovery and test invocation, A2A task management, NHI permission management (agent-to-tool, NHI-to-NHI, user-to-NHI), and A2A agent card discovery. New tabs are added to existing NHI entity detail pages (agents, tools, service-accounts) for MCP Tools, Permissions, and Agent Card. A2A Tasks gets a dedicated sub-page under the NHI section. All data fetched client-side via BFF proxy endpoints.

## Technical Context

**Language/Version**: TypeScript 5.x / Svelte 5 (runes mode) + SvelteKit
**Primary Dependencies**: Bits UI, Tailwind CSS v4, Superforms + Zod (via zod/v3), lucide-svelte, TanStack Table
**Storage**: N/A (backend handles all persistence via xavyo-idp API on localhost:8080)
**Testing**: Vitest + @testing-library/svelte (unit), Chrome DevTools MCP (E2E)
**Target Platform**: Web (all modern browsers)
**Project Type**: Web application (SvelteKit frontend, xavyo-idp backend)
**Performance Goals**: Tab switching < 500ms, MCP tool invoke displays results immediately after backend response
**Constraints**: All API calls via BFF proxy (no direct backend calls from browser), admin role required
**Scale/Scope**: ~4 new BFF proxy route groups, ~3 new API client modules, ~6 new components, tabs added to 3 existing pages, 1 new sub-page

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. BFF Security | PASS | All API calls go through SvelteKit server BFF proxies. No JWT exposure to client. |
| II. TDD | PASS | Tests planned for all API clients, schemas, components, and pages. |
| III. Honest Reviews | PASS | Will run `npm run check`, `npm run test:unit`, and Chrome DevTools MCP E2E. |
| IV. Svelte 5 Runes Only | PASS | All new components use `$state`, `$derived`, `$effect`, `$props`. |
| V. Minimal Complexity | PASS | Reuses existing DataTable, EmptyState, Tabs, skeleton loading. No new libraries. |
| VI. Type Safety | PASS | All API types in types.ts mirror backend Rust DTOs. Zod schemas match. |
| VII. English Only | PASS | All UI text in English. |
| VIII. Backend Fidelity | PASS | All endpoints verified against xavyo-idp source code. See research.md R2-R5. |

**Post-Design Re-check**: All principles still pass. No violations.

## Project Structure

### Documentation (this feature)

```text
specs/013-nhi-protocols-advanced/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Research decisions
├── data-model.md        # Entity definitions
├── quickstart.md        # Test scenarios
├── contracts/           # API contracts
│   ├── mcp-api.md
│   ├── a2a-api.md
│   └── permissions-api.md
├── checklists/
│   └── requirements.md
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── lib/
│   ├── api/
│   │   ├── types.ts                    # ADD: MCP, A2A, Permission, AgentCard types
│   │   ├── mcp.ts                      # NEW: Server-side MCP API client
│   │   ├── mcp-client.ts              # NEW: Client-side MCP fetch wrappers
│   │   ├── a2a.ts                      # NEW: Server-side A2A API client
│   │   ├── a2a-client.ts             # NEW: Client-side A2A fetch wrappers
│   │   ├── nhi-permissions.ts         # NEW: Server-side NHI permissions API client
│   │   ├── nhi-permissions-client.ts  # NEW: Client-side permissions fetch wrappers
│   │   └── nhi.ts                      # EXISTING: extend if needed
│   ├── schemas/
│   │   └── nhi-protocols.ts           # NEW: Zod schemas for forms (create task, grant permission)
│   └── components/
│       └── nhi/
│           ├── mcp-tools-tab.svelte           # NEW: MCP tools list + invoke UI
│           ├── mcp-tool-card.svelte           # NEW: Individual tool with schema + invoke
│           ├── a2a-task-list.svelte           # NEW: Reusable task list component
│           ├── a2a-task-detail.svelte         # NEW: Task detail display
│           ├── permissions-tab.svelte         # NEW: Permissions tab with 3 sections
│           ├── grant-tool-permission-dialog.svelte    # NEW: Grant agent-to-tool dialog
│           ├── grant-nhi-permission-dialog.svelte     # NEW: Grant NHI-to-NHI dialog
│           ├── grant-user-permission-dialog.svelte    # NEW: Grant user-to-NHI dialog
│           ├── agent-card-tab.svelte          # NEW: Agent card display
│           └── json-display.svelte            # NEW: Reusable JSON viewer with copy
├── routes/
│   ├── (app)/
│   │   └── nhi/
│   │       ├── agents/[id]/+page.svelte       # MODIFY: Add tabs (Details, MCP Tools, Permissions, Agent Card)
│   │       ├── agents/[id]/+page.server.ts    # MODIFY: Add server actions for permissions
│   │       ├── tools/[id]/+page.svelte        # MODIFY: Add tabs (Details, MCP Tools, Permissions)
│   │       ├── tools/[id]/+page.server.ts     # MODIFY: Add server actions for permissions
│   │       ├── service-accounts/[id]/+page.svelte    # MODIFY: Add tabs (Details, Permissions)
│   │       ├── service-accounts/[id]/+page.server.ts # MODIFY: Add server actions for permissions
│   │       ├── a2a/+page.svelte               # NEW: A2A tasks list page
│   │       ├── a2a/+page.server.ts            # NEW: A2A tasks list load + actions
│   │       ├── a2a/create/+page.svelte        # NEW: Create A2A task form
│   │       ├── a2a/create/+page.server.ts     # NEW: Create task server action
│   │       ├── a2a/[id]/+page.svelte          # NEW: A2A task detail page
│   │       └── a2a/[id]/+page.server.ts       # NEW: Task detail load + cancel action
│   └── api/
│       └── nhi/
│           ├── mcp/
│           │   ├── tools/+server.ts                    # NEW: GET list MCP tools
│           │   └── tools/[name]/call/+server.ts        # NEW: POST invoke tool
│           ├── a2a/
│           │   ├── tasks/+server.ts                    # NEW: GET list, POST create
│           │   ├── tasks/[id]/+server.ts               # NEW: GET detail
│           │   ├── tasks/[id]/cancel/+server.ts        # NEW: POST cancel
│           │   └── agent-card/[id]/+server.ts          # NEW: GET agent card
│           └── permissions/
│               ├── agents/[agentId]/tools/+server.ts              # NEW: GET list agent tools
│               ├── agents/[agentId]/tools/[toolId]/grant/+server.ts  # NEW: POST grant
│               ├── agents/[agentId]/tools/[toolId]/revoke/+server.ts # NEW: POST revoke
│               ├── tools/[toolId]/agents/+server.ts               # NEW: GET list tool agents
│               ├── [id]/call/[targetId]/grant/+server.ts          # NEW: POST grant NHI-NHI
│               ├── [id]/call/[targetId]/revoke/+server.ts         # NEW: POST revoke NHI-NHI
│               ├── [id]/callers/+server.ts                        # NEW: GET list callers
│               ├── [id]/callees/+server.ts                        # NEW: GET list callees
│               ├── [id]/users/+server.ts                          # NEW: GET list NHI users
│               ├── [id]/users/[userId]/grant/+server.ts           # NEW: POST grant user
│               ├── [id]/users/[userId]/revoke/+server.ts          # NEW: POST revoke user
│               └── users/[userId]/accessible/+server.ts           # NEW: GET user accessible NHIs
```

**Structure Decision**: Extends existing SvelteKit project structure. New API clients in `src/lib/api/`, new components in `src/lib/components/nhi/`, BFF proxies under `src/routes/api/nhi/`, page modifications to existing NHI detail routes, and new A2A sub-pages. Co-located test files (`*.test.ts`) for all new modules.

## Key Implementation Decisions

### 1. Tab Integration on Detail Pages

Existing NHI detail pages (agents, tools, service-accounts) currently use a vertical card layout with no tabs. We add Bits UI Tabs to wrap the existing content:

- **Agents**: Details | MCP Tools | Permissions | Agent Card (4 tabs)
- **Tools**: Details | MCP Tools | Permissions (3 tabs — no agent card for tools)
- **Service Accounts**: Details | Permissions (2 tabs — no MCP tools or agent card)

The "Details" tab contains all existing content (edit/view card, actions card, credentials section). New tab content is loaded client-side when activated.

### 2. Client-Side Data Loading for Tabs

Tab data (MCP tools, permissions, agent card) is fetched client-side via BFF proxy endpoints when the tab is activated. This avoids slowing down the initial page load. Pattern:

```svelte
let mcpTools = $state<McpTool[]>([]);
let isLoadingTools = $state(false);

async function loadMcpTools() {
  isLoadingTools = true;
  const res = await fetch(`/api/nhi/mcp/tools?nhi_id=${data.nhi.id}`);
  const json = await res.json();
  mcpTools = json.tools;
  isLoadingTools = false;
}
```

### 3. A2A Tasks as Separate Sub-Page

A2A tasks span multiple agents, so they don't belong to a single entity's detail page. They get their own route at `/nhi/a2a/` with list, create, and detail pages. The NHI sidebar section is updated to include "A2A Tasks" as a sub-nav item.

### 4. JSON Display Component

A reusable `json-display.svelte` component for rendering JSON payloads (tool schemas, task inputs/results, MCP invoke results). Features:
- Formatted JSON with `JSON.stringify(value, null, 2)`
- `<pre>` with Tailwind monospace font and dark mode support
- Copy-to-clipboard button
- Collapsible with `<details>` for large payloads

### 5. Permission Dialog Pattern

Grant permission dialogs use Bits UI Dialog with embedded forms:
- Agent-to-Tool: Select tool dropdown + optional date picker for expiry
- NHI-to-NHI: Select target NHI dropdown + permission type + optional rate limit + optional expiry
- User-to-NHI: Select user dropdown

Revoke uses the existing confirmation dialog pattern (already used for NHI lifecycle actions).

### 6. Navigation Update

Add "A2A Tasks" to the NHI sub-navigation in the sidebar. The existing NHI section has "Tools", "Agents", "Service Accounts" — we add "A2A Tasks" as a fourth item.

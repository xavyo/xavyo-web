# Data Model: License Management

**Feature**: 027-license-management
**Date**: 2026-02-12

## Entity Relationship Overview

```
LicensePool 1──* LicenseAssignment
LicensePool 1──* ReclamationRule
LicensePool *──* LicensePool (via LicenseIncompatibility, bidirectional)
LicensePool 1──* LicenseEntitlementLink *──1 Entitlement (external)
LicensePool 1──* LicenseAuditEvent
User 1──* LicenseAssignment
```

## Entities

### LicensePool

The core entity representing a software license inventory item.

| Field | Type | Required | Constraints | Notes |
|-------|------|----------|-------------|-------|
| id | UUID | auto | PK | Generated by backend |
| name | string | yes | 1-255 chars, unique per tenant | Pool display name |
| vendor | string | yes | 1-255 chars | Software vendor name |
| description | string | no | — | Optional description |
| total_capacity | integer | yes | >= 0 | Total number of licenses |
| allocated_count | integer | computed | >= 0, <= total_capacity | Current assignments count |
| available_count | integer | computed | total_capacity - allocated_count | Remaining capacity |
| utilization_percent | float | computed | 0.0-100.0 | allocated / total * 100 |
| cost_per_license | decimal | no | >= 0 | Cost per individual license |
| currency | string | yes | 3-char ISO 4217 | Default: "USD" |
| billing_period | enum | yes | Monthly, Annual, Perpetual | Billing cycle |
| license_type | enum | yes | Named, Concurrent | Default: Named |
| expiration_date | datetime | no | — | When pool expires (null = no expiry) |
| expiration_policy | enum | yes | BlockNew, RevokeAll, WarnOnly | Default: BlockNew |
| warning_days | integer | yes | 1-365 | Default: 60. Days before expiry to warn |
| status | enum | computed | Active, Expired, Archived | Based on expiry/archive action |
| created_at | datetime | auto | — | Creation timestamp |
| updated_at | datetime | auto | — | Last update timestamp |
| created_by | UUID | auto | — | Creator's user ID |

**State Transitions**:
- `Active` → `Archived` (via archive action, irreversible)
- `Active` → `Expired` (automatic when expiration_date passes)
- `Archived` / `Expired`: No new assignments allowed

### LicenseAssignment

Tracks individual user-to-pool license allocations.

| Field | Type | Required | Constraints | Notes |
|-------|------|----------|-------------|-------|
| id | UUID | auto | PK | Generated by backend |
| license_pool_id | UUID | yes | FK → LicensePool | Parent pool |
| pool_name | string | enriched | — | Joined from pool |
| user_id | UUID | yes | FK → User | Assigned user |
| user_email | string | enriched | — | Joined from user |
| assigned_at | datetime | auto | — | When assignment was made |
| assigned_by | UUID | auto | — | Who made the assignment |
| source | enum | yes | Manual, Automatic, Entitlement | Default: Manual |
| status | enum | computed | Active, Reclaimed, Expired, Released | Current state |
| reclaimed_at | datetime | no | — | When reclaimed (if applicable) |
| reclaim_reason | string | no | — | Reason for reclamation |
| notes | string | no | — | Optional notes |
| created_at | datetime | auto | — | Creation timestamp |

**Uniqueness**: One active assignment per user per pool.

**State Transitions**:
- `Active` → `Released` (via deallocate action)
- `Active` → `Reclaimed` (via reclamation rule or bulk reclaim)
- `Active` → `Expired` (when pool expires with RevokeAll policy)

### ReclamationRule

Automated rule for reclaiming licenses based on triggers.

| Field | Type | Required | Constraints | Notes |
|-------|------|----------|-------------|-------|
| id | UUID | auto | PK | Generated by backend |
| license_pool_id | UUID | yes | FK → LicensePool | Target pool |
| pool_name | string | enriched | — | Joined from pool |
| pool_vendor | string | enriched | — | Joined from pool |
| trigger_type | enum | yes | Inactivity, LifecycleState | What triggers reclamation |
| threshold_days | integer | conditional | >= 1 | Required if trigger_type = Inactivity |
| lifecycle_state | string | conditional | non-empty | Required if trigger_type = LifecycleState |
| notification_days_before | integer | yes | 0-365 | Default: 7. Days of warning |
| enabled | boolean | yes | — | Default: true |
| created_at | datetime | auto | — | |
| updated_at | datetime | auto | — | |
| created_by | UUID | auto | — | |

### LicenseIncompatibility

Bidirectional conflict rule between two license pools.

| Field | Type | Required | Constraints | Notes |
|-------|------|----------|-------------|-------|
| id | UUID | auto | PK | Generated by backend |
| pool_a_id | UUID | yes | FK → LicensePool | First pool |
| pool_a_name | string | enriched | — | Joined from pool |
| pool_a_vendor | string | enriched | — | Joined from pool |
| pool_b_id | UUID | yes | FK → LicensePool, != pool_a_id | Second pool |
| pool_b_name | string | enriched | — | Joined from pool |
| pool_b_vendor | string | enriched | — | Joined from pool |
| reason | string | yes | non-empty | Why pools are incompatible |
| created_at | datetime | auto | — | |
| created_by | UUID | auto | — | |

**Constraint**: Symmetric unique index — (A, B) and (B, A) are treated as the same rule.

### LicenseEntitlementLink

Links a pool to a governance entitlement for automatic provisioning.

| Field | Type | Required | Constraints | Notes |
|-------|------|----------|-------------|-------|
| id | UUID | auto | PK | Generated by backend |
| license_pool_id | UUID | yes | FK → LicensePool | Pool to link |
| pool_name | string | enriched | — | Joined from pool |
| pool_vendor | string | enriched | — | Joined from pool |
| entitlement_id | UUID | yes | FK → Entitlement | Target entitlement |
| entitlement_name | string | enriched | — | Joined from entitlement |
| priority | integer | yes | >= 0 | Default: 0. Higher = preferred |
| enabled | boolean | yes | — | Default: true |
| created_at | datetime | auto | — | |
| created_by | UUID | auto | — | |

**Uniqueness**: One link per pool-entitlement pair per tenant.

### LicenseAuditEvent

Append-only audit trail for compliance.

| Field | Type | Required | Constraints | Notes |
|-------|------|----------|-------------|-------|
| id | UUID | auto | PK | |
| pool_id | UUID | no | — | Related pool (if applicable) |
| pool_name | string | enriched | — | |
| assignment_id | UUID | no | — | Related assignment (if applicable) |
| user_id | UUID | no | — | Affected user (if applicable) |
| user_email | string | enriched | — | |
| action | string | yes | — | Audit action (e.g., PoolCreated, LicenseAssigned) |
| actor_id | UUID | yes | — | Who performed the action |
| actor_email | string | enriched | — | |
| details | JSON | yes | — | Additional action-specific details |
| created_at | datetime | auto | — | |

### Analytics (Computed, not stored)

**LicenseSummary**: total_pools, total_capacity, total_allocated, total_available, overall_utilization, total_monthly_cost, expiring_soon_count

**LicensePoolStats**: id, name, vendor, total_capacity, allocated_count, utilization_percent, monthly_cost, status, expiration_date

**VendorCost**: vendor, pool_count, total_capacity, allocated_count, monthly_cost, currency

**LicenseRecommendation**: recommendation_type (Underutilized/HighUtilization/ExpiringSoon/ReclaimOpportunity), pool_id, pool_name, description, potential_savings, currency

**ExpiringPoolInfo**: id, name, vendor, expiration_date, days_until_expiration, allocated_count, total_capacity, expiration_policy

**BulkOperationResult**: success_count, failure_count, failures (array of {item_id, error})
